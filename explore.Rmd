---
title: "Warfarin Dosing Service Analysis"
subtitle: "Exploratory Analysis"
author: "Brian Gulbis"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: 
  html_document: 
    code_folding: hide
    fig_caption: yes
    toc: yes
    toc_float: yes
---

```{r global_options, echo=FALSE}
# knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r library, message=FALSE}
library(BGTools)
library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)
```

```{r data, echo=FALSE}
tmp <- get_rds("tidy")
```


## Warfarin Dosing Service

### Groups

* Current: warfarin started between January 1, 2015 and December 31, 2015
* Historical: warfarin started between July 1, 2012 and December 31, 2014

```{r groups}
total <- pts.include %>%
    group_by(group, year) %>%
    summarize(total = n())

groups <- total %>%
    spread(year, total)

knitr::kable(groups, caption = "Number of patients per group")
```

### Indications

```{r indications, fig.cap="Indications for warfarin use"}
counts <- pts.include %>%
    inner_join(data.warfarin.indications, by = "pie.id") %>%
    gather(indication, value, -pie.id, -group, -year) %>%
    filter(value == TRUE) %>%
    group_by(group, year, indication) %>%
    summarize(n = n()) %>%
    left_join(total, by = c("group", "year")) %>%
    mutate(perc = n / total) 

ggplot(data = counts, aes(x = indication, fill = group)) +
    geom_bar(aes(y = perc), stat = "identity", position = "dodge") + 
    facet_grid(year ~ .) +
    ylab("Patients (%)") +
    scale_y_continuous(labels = percent) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Dispositions

```{r disposition, fig.cap="Disposition on discharge"}
counts <- pts.include %>% 
    inner_join(data.demographics, by = "pie.id") %>%
    group_by(group, year, disposition) %>%
    summarize(n = n()) %>%
    left_join(total, by = c("group", "year")) %>%
    mutate(perc = n / total) 
    
ggplot(data = counts, aes(x = disposition, fill = group)) +
    geom_bar(aes(y = perc), stat = "identity", position = "dodge") + 
    facet_grid(year ~ .) +
    ylab("Patients (%)") +
    scale_y_continuous(labels = percent) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## Exploratory Plots

### Change in INR
```{r inr, fig.cap="Change in INR after starting warfarin"}
pts.include %>%
    inner_join(data.labs.inrs, by = "pie.id") %>%
    calc_lab_runtime(units = "days") %>%
    ggplot(aes(x = run.time, y = lab.result)) +
    facet_grid(year ~ group) +
    geom_point(alpha = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "green") +
    geom_smooth(color = "blue") + 
    xlab("Day") +
    ylab("INR") +
    scale_x_continuous(breaks = seq(-2, 10, by = 2)) +
    coord_cartesian(xlim = c(-2, 10), ylim = c(1, 4)) 
```

### INR in therapuetic range
```{r inrange, fig.cap="Percent of time INR is within therapeutic range"}
pts.include %>%
    inner_join(data.inr.inrange, by = "pie.id") %>%
    ggplot(aes(x = group, y = perc.time)) +
    geom_boxplot() +
    facet_grid(year ~ .) +
    ylab("Time in Therapeutic Range (%)")
```

### Change in Hgb
```{r hgb, fig.cap="Change in hemoglobin after starting warfarin"}
pts.include %>%
    inner_join(data.labs.hgb, by = "pie.id") %>%
    calc_lab_runtime(units = "days") %>%
    ggplot(aes(x = run.time, y = lab.result)) +
    facet_grid(year ~ group) +
    geom_point(alpha = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", color = "green") +
    geom_smooth(color = "blue") + 
    xlab("Day") +
    ylab("Hgb (g/dL)") +
    scale_x_continuous(breaks = seq(-2, 10, by = 2)) +
    coord_cartesian(xlim = c(-2, 10), ylim = c(5, 15)) 
```



